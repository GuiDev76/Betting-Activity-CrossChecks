<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Détection Fraude - Paris Coordonnés</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel pour JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo } = React;
        const { Upload, AlertTriangle, Users, Clock, TrendingUp, Filter, Download } = lucide;

        const Icon = ({ icon: IconComponent, ...props }) => {
            const ref = React.useRef(null);
            
            React.useEffect(() => {
                if (ref.current) {
                    lucide.createElement(IconComponent).render(ref.current);
                }
            }, [IconComponent]);
            
            return <i ref={ref} {...props}></i>;
        };

        const FraudDetectionDashboard = () => {
            const [data, setData] = useState(null);
            const [timeWindow, setTimeWindow] = useState(15);
            const [selectedEvent, setSelectedEvent] = useState(null);

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const text = await file.text();
                const lines = text.split('\n');
                const headers = lines[0].split(';');
                
                const parsedData = lines.slice(1)
                    .filter(line => line.trim())
                    .map(line => {
                        const values = line.split(';');
                        return headers.reduce((obj, header, index) => {
                            obj[header.trim()] = values[index]?.trim() || '';
                            return obj;
                        }, {});
                    });

                setData(parsedData);
            };

            const fraudClusters = useMemo(() => {
                if (!data) return [];

                const clusters = [];
                const processed = new Set();

                data.forEach((bet, index) => {
                    if (processed.has(index)) return;

                    const betTime = new Date(`${bet['Placement Time']?.replace(' ', 'T')}`);
                    if (isNaN(betTime)) return;

                    const relatedBets = data
                        .map((b, i) => ({ ...b, originalIndex: i }))
                        .filter((b, i) => {
                            if (i === index || processed.has(i)) return false;
                            
                            const bTime = new Date(`${b['Placement Time']?.replace(' ', 'T')}`);
                            if (isNaN(bTime)) return false;

                            const timeDiff = Math.abs(bTime - betTime) / (1000 * 60);
                            
                            return (
                                timeDiff <= timeWindow &&
                                b.Event === bet.Event &&
                                b['Selection Name'] === bet['Selection Name'] &&
                                b['Party ID'] !== bet['Party ID']
                            );
                        });

                    if (relatedBets.length > 0) {
                        const allBets = [{ ...bet, originalIndex: index }, ...relatedBets];
                        allBets.forEach(b => processed.add(b.originalIndex));

                        const times = allBets.map(b => new Date(`${b['Placement Time']?.replace(' ', 'T')}`));
                        const minTime = new Date(Math.min(...times));
                        const maxTime = new Date(Math.max(...times));
                        const timeSpanMinutes = (maxTime - minTime) / (1000 * 60);

                        clusters.push({
                            event: bet.Event,
                            selection: bet['Selection Name'],
                            sport: bet['Sport Type Name'],
                            competition: bet.Competition,
                            eventDate: bet['Event Date'],
                            players: allBets.map(b => b['Party ID']),
                            bets: allBets,
                            timeSpan: timeSpanMinutes,
                            firstBet: minTime,
                            lastBet: maxTime,
                            totalStake: allBets.reduce((sum, b) => sum + parseFloat(b['Total Stake'] || 0), 0),
                            severity: timeSpanMinutes <= 5 ? 'critical' : timeSpanMinutes <= 15 ? 'high' : 'medium'
                        });
                    }
                });

                return clusters.sort((a, b) => a.timeSpan - b.timeSpan);
            }, [data, timeWindow]);

            const stats = useMemo(() => {
                if (!fraudClusters.length) return null;

                const uniquePlayers = new Set();
                fraudClusters.forEach(c => c.players.forEach(p => uniquePlayers.add(p)));

                return {
                    totalClusters: fraudClusters.length,
                    criticalClusters: fraudClusters.filter(c => c.severity === 'critical').length,
                    suspiciousPlayers: uniquePlayers.size,
                    totalStakeInvolved: fraudClusters.reduce((sum, c) => sum + c.totalStake, 0)
                };
            }, [fraudClusters]);

            const exportResults = () => {
                if (!fraudClusters.length) return;

                const csv = [
                    ['Événement', 'Sélection', 'Joueurs Impliqués', 'Écart Temporel (min)', 'Sévérité', 'Mise Totale', 'Premier Paris', 'Dernier Paris'].join(';'),
                    ...fraudClusters.map(c => [
                        c.event,
                        c.selection,
                        c.players.join(' | '),
                        c.timeSpan.toFixed(2),
                        c.severity === 'critical' ? 'CRITIQUE' : c.severity === 'high' ? 'ÉLEVÉ' : 'MOYEN',
                        c.totalStake.toFixed(2),
                        c.firstBet.toLocaleString('fr-FR'),
                        c.lastBet.toLocaleString('fr-FR')
                    ].join(';'))
                ].join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fraude_detection_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            const getSeverityColor = (severity) => {
                switch(severity) {
                    case 'critical': return 'bg-red-100 border-red-500 text-red-900';
                    case 'high': return 'bg-orange-100 border-orange-500 text-orange-900';
                    case 'medium': return 'bg-yellow-100 border-yellow-500 text-yellow-900';
                    default: return 'bg-gray-100 border-gray-500 text-gray-900';
                }
            };

            const getSeverityBadge = (severity) => {
                switch(severity) {
                    case 'critical': return 'bg-red-600 text-white';
                    case 'high': return 'bg-orange-600 text-white';
                    case 'medium': return 'bg-yellow-600 text-white';
                    default: return 'bg-gray-600 text-white';
                }
            };

            if (!data) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-8">
                        <div className="max-w-4xl mx-auto">
                            <div className="text-center mb-12">
                                <h1 className="text-4xl font-bold text-white mb-4">
                                    Détection de Fraude - Paris Coordonnés
                                </h1>
                                <p className="text-slate-300 text-lg">
                                    Identifiez les réseaux de comptes frauduleux en quelques secondes
                                </p>
                            </div>

                            <div className="bg-white rounded-2xl shadow-2xl p-12">
                                <div className="flex flex-col items-center">
                                    <div className="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-6">
                                        <Icon icon={Upload} className="w-12 h-12 text-blue-600" />
                                    </div>
                                    
                                    <h2 className="text-2xl font-semibold text-gray-900 mb-3">
                                        Importer les données de paris
                                    </h2>
                                    
                                    <p className="text-gray-600 text-center mb-8 max-w-md">
                                        Glissez-déposez votre fichier CSV ou cliquez pour sélectionner
                                    </p>

                                    <label className="cursor-pointer">
                                        <input
                                            type="file"
                                            accept=".csv"
                                            onChange={handleFileUpload}
                                            className="hidden"
                                        />
                                        <div className="px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-colors duration-200 shadow-lg hover:shadow-xl">
                                            Sélectionner un fichier CSV
                                        </div>
                                    </label>

                                    <div className="mt-12 grid grid-cols-3 gap-6 w-full max-w-2xl">
                                        <div className="text-center p-4 bg-red-50 rounded-lg">
                                            <div className="text-red-600 font-bold text-lg mb-1">1-5 min</div>
                                            <div className="text-sm text-gray-600">CRITIQUE</div>
                                        </div>
                                        <div className="text-center p-4 bg-orange-50 rounded-lg">
                                            <div className="text-orange-600 font-bold text-lg mb-1">5-15 min</div>
                                            <div className="text-sm text-gray-600">TRÈS SUSPECT</div>
                                        </div>
                                        <div className="text-center p-4 bg-yellow-50 rounded-lg">
                                            <div className="text-yellow-600 font-bold text-lg mb-1">15-30 min</div>
                                            <div className="text-sm text-gray-600">SUSPECT</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-xl shadow-sm p-6 mb-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900">Détection de Fraude</h1>
                                    <p className="text-gray-600 mt-1">{data.length} paris analysés</p>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={exportResults}
                                        className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                    >
                                        <Icon icon={Download} className="w-4 h-4" />
                                        Exporter Résultats
                                    </button>
                                    <label className="cursor-pointer flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        <Icon icon={Upload} className="w-4 h-4" />
                                        Nouveau fichier
                                        <input
                                            type="file"
                                            accept=".csv"
                                            onChange={handleFileUpload}
                                            className="hidden"
                                        />
                                    </label>
                                </div>
                            </div>
                        </div>

                        {stats && (
                            <div className="grid grid-cols-4 gap-4 mb-6">
                                <div className="bg-white rounded-xl shadow-sm p-6">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm text-gray-600 mb-1">Clusters Détectés</p>
                                            <p className="text-3xl font-bold text-gray-900">{stats.totalClusters}</p>
                                        </div>
                                        <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                            <Icon icon={TrendingUp} className="w-6 h-6 text-blue-600" />
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl shadow-sm p-6">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm text-gray-600 mb-1">Alertes Critiques</p>
                                            <p className="text-3xl font-bold text-red-600">{stats.criticalClusters}</p>
                                        </div>
                                        <div className="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                            <Icon icon={AlertTriangle} className="w-6 h-6 text-red-600" />
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl shadow-sm p-6">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm text-gray-600 mb-1">Joueurs Suspects</p>
                                            <p className="text-3xl font-bold text-orange-600">{stats.suspiciousPlayers}</p>
                                        </div>
                                        <div className="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                            <Icon icon={Users} className="w-6 h-6 text-orange-600" />
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl shadow-sm p-6">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm text-gray-600 mb-1">Mise Totale</p>
                                            <p className="text-3xl font-bold text-gray-900">{stats.totalStakeInvolved.toFixed(0)}€</p>
                                        </div>
                                        <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                            <Icon icon={Clock} className="w-6 h-6 text-purple-600" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-white rounded-xl shadow-sm p-4 mb-6">
                            <div className="flex items-center gap-4">
                                <Icon icon={Filter} className="w-5 h-5 text-gray-600" />
                                <label className="flex items-center gap-2">
                                    <span className="text-sm font-medium text-gray-700">Fenêtre temporelle:</span>
                                    <select
                                        value={timeWindow}
                                        onChange={(e) => setTimeWindow(Number(e.target.value))}
                                        className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value={5}>5 minutes</option>
                                        <option value={15}>15 minutes</option>
                                        <option value={30}>30 minutes</option>
                                        <option value={60}>60 minutes</option>
                                    </select>
                                </label>
                            </div>
                        </div>

                        <div className="space-y-4">
                            {fraudClusters.map((cluster, index) => (
                                <div
                                    key={index}
                                    className={`bg-white rounded-xl shadow-sm border-l-4 ${getSeverityColor(cluster.severity)} p-6 hover:shadow-md transition-shadow cursor-pointer`}
                                    onClick={() => setSelectedEvent(selectedEvent === index ? null : index)}
                                >
                                    <div className="flex items-start justify-between mb-4">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-3 mb-2">
                                                <span className={`px-3 py-1 rounded-full text-xs font-bold ${getSeverityBadge(cluster.severity)}`}>
                                                    {cluster.timeSpan.toFixed(1)} min
                                                </span>
                                                <span className="text-xs text-gray-500">{cluster.sport}</span>
                                            </div>
                                            <h3 className="text-lg font-semibold text-gray-900 mb-1">{cluster.event}</h3>
                                            <p className="text-sm text-gray-600">{cluster.competition}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-sm text-gray-600">Joueurs impliqués</p>
                                            <p className="text-2xl font-bold text-gray-900">{cluster.players.length}</p>
                                        </div>
                                    </div>

                                    <div className="bg-gray-50 rounded-lg p-4 mb-4">
                                        <p className="text-sm font-medium text-gray-700 mb-1">Sélection pariée:</p>
                                        <p className="text-base font-semibold text-gray-900">{cluster.selection}</p>
                                    </div>

                                    <div className="grid grid-cols-3 gap-4 text-sm">
                                        <div>
                                            <p className="text-gray-600">Premier pari</p>
                                            <p className="font-medium text-gray-900">{cluster.firstBet.toLocaleTimeString('fr-FR')}</p>
                                        </div>
                                        <div>
                                            <p className="text-gray-600">Dernier pari</p>
                                            <p className="font-medium text-gray-900">{cluster.lastBet.toLocaleTimeString('fr-FR')}</p>
                                        </div>
                                        <div>
                                            <p className="text-gray-600">Mise totale</p>
                                            <p className="font-medium text-gray-900">{cluster.totalStake.toFixed(2)}€</p>
                                        </div>
                                    </div>

                                    {selectedEvent === index && (
                                        <div className="mt-6 pt-6 border-t border-gray-200">
                                            <h4 className="font-semibold text-gray-900 mb-3">Détail des paris ({cluster.bets.length})</h4>
                                            <div className="space-y-2">
                                                {cluster.bets.map((bet, bidx) => (
                                                    <div key={bidx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                        <div className="flex items-center gap-4">
                                                            <span className="font-mono text-sm font-semibold text-blue-600">#{bet['Party ID']}</span>
                                                            <span className="text-sm text-gray-600">{bet['Placement Time']}</span>
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <span className="text-sm font-medium">{bet['Total Stake']}€</span>
                                                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                                                                bet['Bet Status'] === 'Won' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                            }`}>
                                                                {bet['Bet Status']}
                                                            </span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        {fraudClusters.length === 0 && (
                            <div className="bg-white rounded-xl shadow-sm p-12 text-center">
                                <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icon icon={AlertTriangle} className="w-8 h-8 text-green-600" />
                                </div>
                                <h3 className="text-xl font-semibold text-gray-900 mb-2">Aucune activité suspecte détectée</h3>
                                <p className="text-gray-600">Aucun cluster de paris coordonnés trouvé dans la fenêtre temporelle sélectionnée.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<FraudDetectionDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
